name: Build Images (Manual)

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build'
        required: true
        type: choice
        options:
          - minio
          - mongodb
          - postgresql
          - kubectl
      version_suffix:
        description: 'Version suffix (e.g., -debug, -hotfix). Leave empty for base version from Chart.yaml'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (build but do not push)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      GAR_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_PROD }}
      GAR_LOCATION:   ${{ secrets.GAR_LOCATION }}
      GAR_REPOSITORY: testkube
    steps:
      - uses: actions/checkout@v4
      - uses: depot/setup-action@v1
      
      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.GAR_PROJECT_ID }}
          credentials_json: ${{ secrets.GKE_SA_KEY_PROD }}
      
      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev -q
      
      - name: Extract version from Chart.yaml
        id: version
        run: |
          SERVICE="${{ inputs.service }}"
          BASE_VERSION=$(grep "^appVersion:" ${SERVICE}/helm/Chart.yaml | sed 's/appVersion: "//' | sed 's/"//g' | tr -d '[:space:]')
          SUFFIX="${{ inputs.version_suffix }}"
          
          FINAL_VERSION="${BASE_VERSION}${SUFFIX}"
          
          echo "base_version=$BASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "suffix=$SUFFIX" >> "$GITHUB_OUTPUT"
          echo "tag=$FINAL_VERSION" >> "$GITHUB_OUTPUT"
          
          echo "ðŸ“¦ Service: $SERVICE"
          echo "ðŸ“Œ Base Version: $BASE_VERSION"
          echo "ðŸ·ï¸ Suffix: $SUFFIX"
          echo "ðŸŽ¯ Final Tag: $FINAL_VERSION"
      
      - name: Create Docker tags and metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          bake-target: ${{ inputs.service }}
          images: |
            ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ inputs.service }}
          tags: |
            type=raw,value=${{ steps.version.outputs.tag }}
      
      - name: Build and push image
        uses: depot/bake-action@v1.12.1
        with:
          project: ${{ secrets.DEPOT_PROJECT_ID }}
          targets: ${{ inputs.service }}
          files: |
            ./docker-bake.hcl
            ${{ steps.meta.outputs.bake-file }}
          push: ${{ inputs.dry_run == false }}
      
      - name: Summary
        run: |
          SERVICE="${{ inputs.service }}"
          VERSION="${{ steps.version.outputs.tag }}"
          GAR_IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${SERVICE}"
          DRY_RUN="${{ inputs.dry_run }}"
          
          echo "### ðŸ³ Manual Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | **${SERVICE}** |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Version | \`${{ steps.version.outputs.base_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Suffix | \`${{ steps.version.outputs.suffix }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Final Tag | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${GAR_IMAGE}:${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${DRY_RUN} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$DRY_RUN" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Dry run mode** - Image was built but NOT pushed to GAR" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Image successfully pushed to GAR" >> $GITHUB_STEP_SUMMARY
          fi
