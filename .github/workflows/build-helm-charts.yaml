name: Build Helm Charts

on:
  push:
    branches: [main]

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  build:
    runs-on: depot-ubuntu-22.04
    permissions:
      contents: read
      id-token: write
    env:
      GAR_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_PROD }}
      GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
      CHARTS_REPOSITORY: testkube
    steps:
      - uses: actions/checkout@v4
      
      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.GAR_PROJECT_ID }}
          credentials_json: ${{ secrets.GKE_SA_KEY_PROD }}
      
      - name: Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev -q
      
      - name: Publish Helm Charts
        id: helm-publish
        run: |
          PUBLISHED_CHARTS=""
          
          for chart in minio mongodb postgresql kubectl; do
            # Check if helm chart exists for this service
            if [ -d "$chart/helm" ]; then
              echo "=== Processing $chart helm chart ==="
              
              echo "Building dependencies..."
              helm dependency build $chart/helm
              
              echo "Packaging chart..."
              helm package $chart/helm
              
              echo "Publishing to GAR..."
              CHART_FILE=$(ls -A | grep -e "^$chart.*tgz$" | head -1)
              if [ -n "$CHART_FILE" ]; then
                helm push "$CHART_FILE" \
                  oci://${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT_ID }}/${{ env.CHARTS_REPOSITORY }}
                PUBLISHED_CHARTS="$PUBLISHED_CHARTS $chart"
                echo "âœ… $chart published successfully"
              else
                echo "âš ï¸ No chart file found for $chart"
              fi
              
              echo ""
            else
              echo "â­ï¸ Skipping $chart (no helm chart found)"
            fi
          done
          
          echo "published=$PUBLISHED_CHARTS" >> "$GITHUB_OUTPUT"
      
      - name: Summary
        run: |
          echo "### ðŸ“¦ Helm Charts Published to GAR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          for chart in minio mongodb postgresql kubectl; do
            if [ -d "$chart/helm" ]; then
              echo "| $chart | âœ… Published |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $chart | â­ï¸ Skipped (no chart) |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`oci://${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GAR_PROJECT_ID }}/${{ env.CHARTS_REPOSITORY }}\`" >> $GITHUB_STEP_SUMMARY


