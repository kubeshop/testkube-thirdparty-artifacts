name: Check MinIO Updates

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual execution
    inputs:
      dry_run:
        description: 'Check only without creating PR (dry-run)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: check-minio-updates
  cancel-in-progress: false

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create PR
      pull-requests: write  # Required to create PR
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Check for MinIO updates
        id: check-updates
        run: |
          cd minio/scripts
          chmod +x check-and-update-minio.sh
          
          # Determine if dry-run mode (manual with input or scheduled always updates)
          DRY_RUN_FLAG=""
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.dry_run }}" == "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "Running in dry-run mode (manual trigger)"
          fi
          
          # Run script in dry-run mode first to check
          if ./check-and-update-minio.sh $DRY_RUN_FLAG 2>&1 | tee /tmp/check-output.log; then
            echo "has_update=true" >> "$GITHUB_OUTPUT"
            # Extract versions from output (search for both Spanish and English text for compatibility)
            CURRENT_VERSION=$(grep -E "Versión actual|Current version" /tmp/check-output.log | awk '{print $NF}')
            LATEST_VERSION=$(grep -E "Versión oficial|Latest version" /tmp/check-output.log | tail -1 | awk '{print $NF}')
            echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
            echo "latest_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            
            # Extract semantic version for PR title
            SEMANTIC_VERSION=$(echo "$LATEST_VERSION" | sed -E 's/RELEASE\.([0-9]{4})-([0-9]{2}).*/\1.\2/')
            echo "semantic_version=$SEMANTIC_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "has_update=false" >> "$GITHUB_OUTPUT"
            echo "No update available"
          fi
          
          # If manual dry-run, don't create PR
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "create_pr=false" >> "$GITHUB_OUTPUT"
          else
            echo "create_pr=${{ steps.check-updates.outputs.has_update }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Update MinIO version and create PR
        if: steps.check-updates.outputs.create_pr == 'true'
        run: |
          cd minio/scripts
          ./check-and-update-minio.sh --update-files

      - name: Configure Git
        if: steps.check-updates.outputs.create_pr == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Generate AI-powered PR description
        if: steps.check-updates.outputs.create_pr == 'true'
        id: ai-description
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cd minio/scripts
          chmod +x generate-pr-description.sh
          
          # Generate PR description with AI
          ./generate-pr-description.sh \
            --current-version "${{ steps.check-updates.outputs.current_version }}" \
            --new-version "${{ steps.check-updates.outputs.latest_version }}" \
            --output /tmp/pr-description.md
          
          # Save output for next step
          {
            echo 'pr_body<<EOFMARKER'
            cat /tmp/pr-description.md
            echo 'EOFMARKER'
          } >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.check-updates.outputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: Update MinIO to version ${{ steps.check-updates.outputs.latest_version }}
            
            Automated update from Docker Hub.
            - Current version: ${{ steps.check-updates.outputs.current_version }}
            - New version: ${{ steps.check-updates.outputs.latest_version }}
          title: "chore: Update MinIO to version ${{ steps.check-updates.outputs.semantic_version }}"
          body: ${{ steps.ai-description.outputs.pr_body }}
          branch: update/minio-${{ steps.check-updates.outputs.semantic_version }}
          delete-branch: true
          labels: |
            automated
            minio
            dependencies
            ai-generated
          draft: false

      - name: Output result
        run: |
          if [ "${{ steps.check-updates.outputs.has_update }}" == "true" ]; then
            if [ "${{ steps.check-updates.outputs.create_pr }}" == "true" ]; then
              echo "✅ New MinIO version detected: ${{ steps.check-updates.outputs.latest_version }}"
              echo "✅ Pull Request created successfully"
            else
              echo "✅ New MinIO version detected: ${{ steps.check-updates.outputs.latest_version }}"
              echo "ℹ️  Dry-run mode: No PR created. Run without dry-run to create PR."
            fi
          else
            echo "ℹ️  MinIO is up to date. No update needed."
          fi

